<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Calculator Pro - Advanced UK Solar ROI Analysis</title>
    <meta name="description" content="Professional solar panel ROI calculator with postcode-specific data, battery analysis, and detailed reports.">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PWME39QWJD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PWME39QWJD');
      
      // Track Pro purchase completion
      function trackProPurchase() {
        gtag('event', 'purchase', {
          'transaction_id': 'pro_' + Date.now(),
          'value': 4.99,
          'currency': 'GBP',
          'items': [{
            'item_id': 'solar_calc_pro',
            'item_name': 'Solar Calculator Pro Access',
            'price': 4.99,
            'quantity': 1
          }]
        });
      }
      
      // Track Pro calculator usage
      function trackProCalculation() {
        gtag('event', 'pro_calculation', {
          'event_category': 'engagement',
          'event_label': 'pro_calculator_used'
        });
      }
      
      // Track report download
      function trackReportDownload() {
        gtag('event', 'download_report', {
          'event_category': 'engagement',
          'event_label': 'pro_report_downloaded'
        });
      }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f8f9fa;
        }
        
        .pro-header {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .pro-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .success-message {
            background: #4caf50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #f57c00;
            border-bottom-color: #f57c00;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #f57c00;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: transform 0.2s;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245,124,0,0.3);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .result-card.highlight {
            border-color: #f57c00;
            background: #fff3e0;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: bold;
            color: #f57c00;
            margin: 10px 0;
        }
        
        .result-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .monthly-breakdown {
            margin: 30px 0;
            overflow-x: auto;
        }
        
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .breakdown-table th, .breakdown-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .breakdown-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .download-section {
            background: #e3f2fd;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 30px 0;
        }
        
        .download-btn {
            background: #2196f3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
        }
        
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .system-comparison {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .system-comparison:hover {
            border-color: #f57c00;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .best-choice {
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .time-shift-table {
            background: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .time-shift-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .time-shift-table th, .time-shift-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #f57c00;
        }
        
        @media (max-width: 600px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 45%;
            }
        }
    </style>
</head>
<body>
    <div class="pro-header">
        <div class="container">
            <div class="pro-badge">PRO VERSION</div>
            <h1>⭐ Solar Calculator Pro</h1>
            <p>Advanced analysis with postcode-specific data | Using current Ofgem rates</p>
        </div>
    </div>

    <div class="container">
        <div class="success-message" id="successMessage">
            ✅ Payment successful! Welcome to Solar Calculator Pro.
        </div>
        
        <div id="mainContent">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('advanced')">Advanced Calculator</button>
                <button class="tab" onclick="switchTab('battery')">Battery Analysis</button>
                <button class="tab" onclick="switchTab('comparison')">System Comparison</button>
                <button class="tab" onclick="switchTab('monthly')">Monthly Breakdown</button>
            </div>

            <!-- Advanced Calculator Tab -->
            <div class="tab-content active" id="advanced">
                <h2>Postcode-Specific Solar Analysis</h2>
                
                <div class="input-group">
                    <label for="postcode">Your Postcode</label>
                    <input type="text" id="postcode" placeholder="e.g., SW1A 1AA">
                    <small style="color: #666;">Precise sunshine hours from UK historical weather data (30-year average)</small>
                </div>
                
                <div class="input-group">
                    <label for="roofArea">Available Roof Area (m²)</label>
                    <input type="number" id="roofArea" value="40" min="10" max="200">
                    <small style="color: #666;">Typical UK roof: 40-60m²</small>
                </div>
                
                <div class="input-group">
                    <label for="systemSizePro">Recommended System Size (kW)</label>
                    <select id="systemSizePro">
                        <option value="3">3 kW - Small (12-15 panels) - £4,500</option>
                        <option value="4">4 kW - Average (16-20 panels) - £5,500</option>
                        <option value="6" selected>6 kW - Large (24-30 panels) - £7,500</option>
                        <option value="8">8 kW - Very Large (32-40 panels) - £10,000</option>
                        <option value="10">10 kW - Maximum (40+ panels) - £13,000</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="energyUsagePattern">When do you use most electricity?</label>
                    <select id="energyUsagePattern">
                        <option value="day">Mostly daytime (work from home)</option>
                        <option value="evening">Mostly evenings (out during day)</option>
                        <option value="mixed">Mixed usage</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="currentTariff">Your Current Electricity Rate (p/kWh)</label>
                    <input type="number" id="currentTariff" value="27.03" step="0.01" min="5" max="50">
                    <small style="color: #666;">Ofgem cap: 27.03p (drops to 25.73p July 2025) | Octopus Agile: ~19p</small>
                </div>
                
                <div class="input-group">
                    <label for="exportTariff">Smart Export Guarantee Rate (p/kWh)</label>
                    <input type="number" id="exportTariff" value="7.5" step="0.1" min="0" max="20">
                    <small style="color: #666;">Octopus 15p | British Gas 6.4p | E.ON 5.5p | Average 7.5p</small>
                </div>
                
                <button type="submit" class="calculate-btn" onclick="calculateProROI()">Calculate Advanced ROI →</button>
                
                <div id="proResults" style="display: none;">
                    <h3>Your Personalised Results</h3>
                    <div class="results-grid">
                        <div class="result-card highlight">
                            <div class="result-title">Location Efficiency</div>
                            <div class="result-value" id="locationEfficiency">-</div>
                            <small>vs UK average</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Annual Generation</div>
                            <div class="result-value" id="annualGeneration">-</div>
                            <small>kWh per year</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Export Income</div>
                            <div class="result-value" id="exportIncome">-</div>
                            <small>per year</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">True Payback</div>
                            <div class="result-value" id="truePayback">-</div>
                            <small>including all costs</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battery Analysis Tab -->
            <div class="tab-content" id="battery">
                <h2>Battery Storage ROI Analysis</h2>
                <p style="color: #666; margin-bottom: 20px;">See how batteries save money through time-shifting: charge at cheap overnight rates, use during expensive peak times</p>
                
                <div class="input-group">
                    <label for="batterySize">Battery Capacity (kWh)</label>
                    <select id="batterySize">
                        <option value="0">No battery</option>
                        <option value="5">5 kWh (£2,500)</option>
                        <option value="10" selected>10 kWh (£5,000)</option>
                        <option value="13.5">13.5 kWh Tesla Powerwall (£8,000)</option>
                        <option value="15">15 kWh (£7,500)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="timeOfUseRate">Night Rate Electricity (p/kWh)</label>
                    <input type="number" id="timeOfUseRate" value="7" step="0.1">
                    <small style="color: #666;">Octopus Go: 7p (00:30-04:30) | Economy 7: varies by region</small>
                </div>
                
                <div class="input-group">
                    <label for="dayRate">Peak Rate Electricity (p/kWh)</label>
                    <input type="number" id="dayRate" value="27.03" step="0.01">
                    <small style="color: #666;">Your daytime electricity rate</small>
                </div>
                
                <button class="calculate-btn" onclick="calculateBatteryROI()">Analyse Battery Investment →</button>
                
                <div id="batteryResults" style="display: none;">
                    <h3>Battery Storage Analysis</h3>
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-title">Daily Savings</div>
                            <div class="result-value" id="dailySavings">-</div>
                            <small>from time-shifting</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Annual Savings</div>
                            <div class="result-value" id="batterySavings">-</div>
                            <small>per year</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Battery Payback</div>
                            <div class="result-value" id="batteryPayback">-</div>
                            <small>years</small>
                        </div>
                        <div class="result-card highlight">
                            <div class="result-title">Worth It?</div>
                            <div class="result-value" id="batteryVerdict">-</div>
                        </div>
                    </div>
                    
                    <div class="time-shift-table" id="timeShiftBreakdown" style="display: none;">
                        <h4>Time-Shifting Breakdown</h4>
                        <table>
                            <tr>
                                <th>Time</th>
                                <th>Action</th>
                                <th>Rate</th>
                                <th>Daily Saving</th>
                            </tr>
                            <tr>
                                <td>00:30 - 04:30</td>
                                <td>Charge battery</td>
                                <td id="chargeRate">-</td>
                                <td id="chargeCost">-</td>
                            </tr>
                            <tr>
                                <td>Peak hours</td>
                                <td>Use battery power</td>
                                <td id="peakRate">-</td>
                                <td id="peakSaving">-</td>
                            </tr>
                            <tr style="font-weight: bold;">
                                <td colspan="3">Total daily saving</td>
                                <td id="totalDailySaving">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- System Comparison Tab -->
            <div class="tab-content" id="comparison">
                <h2>Compare Different System Sizes</h2>
                <p>Based on your roof and usage, here's how different systems compare:</p>
                
                <div class="comparison-container" id="comparisonResults">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Please complete the Advanced Calculator first to see system comparisons based on your specific location and usage patterns.
                    </p>
                </div>
            </div>

            <!-- Monthly Breakdown Tab -->
            <div class="tab-content" id="monthly">
                <h2>Month-by-Month Analysis</h2>
                <p style="color: #666; margin-bottom: 10px;">Year 1 generation and savings by month</p>
                
                <div class="monthly-breakdown">
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Generation (kWh)</th>
                                <th>Self-Use</th>
                                <th>Export</th>
                                <th>Savings</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyData">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                    Please complete the Advanced Calculator first to see your monthly breakdown.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Download Section -->
            <div class="download-section">
                <h3>📄 Download Your Investment Analysis</h3>
                <p>Get a detailed breakdown of your solar investment with all calculations and recommendations</p>
                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <p style="margin: 0; font-size: 0.9em;"><strong>Your comprehensive report includes:</strong></p>
                    <ul style="margin: 10px 0 0 20px; font-size: 0.9em;">
                        <li>✓ Executive summary with key ROI metrics</li>
                        <li>✓ Month-by-month generation & savings breakdown</li>
                        <li>✓ Year-by-year financial projections (5 years detailed)</li>
                        <li>✓ System sizing recommendations for your roof</li>
                        <li>✓ Battery storage ROI analysis (if applicable)</li>
                        <li>✓ Installation checklist & next steps</li>
                    </ul>
                </div>
                <button class="download-btn" onclick="generateReport()">Download Analysis Summary →</button>
                <p style="font-size: 0.8em; color: #666; margin-top: 10px;">Detailed summary report with your calculations and key recommendations</p>
            </div>
        </div>
    </div>

    <script>
        // Basic protection
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => {
            if (e.target.tagName !== 'INPUT') e.preventDefault();
        });
        
        // STRICT Security Check
        window.onload = function() {
            console.log('Security check starting...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            console.log('Session ID found:', sessionId);
            
            // Check for valid Stripe session
            if (sessionId && sessionId.startsWith('cs_')) {
                console.log('Valid session detected');
                document.getElementById('successMessage').style.display = 'block';
                localStorage.setItem('solarProAccess', 'true');
                localStorage.setItem('proSessionId', sessionId);
                localStorage.setItem('proAccessDate', new Date().toISOString());
                
                // Track purchase
                if (typeof trackProPurchase === 'function') {
                    trackProPurchase();
                }
                return; // Allow access
            }
            
            // Check localStorage for previous access
            const storedAccess = localStorage.getItem('solarProAccess');
            const storedSession = localStorage.getItem('proSessionId');
            
            console.log('Stored access:', storedAccess);
            console.log('Stored session:', storedSession);
            
            if (storedAccess && storedSession && storedSession.startsWith('cs_')) {
                console.log('Valid stored session found');
                document.getElementById('successMessage').innerHTML = '✅ Welcome back to Solar Calculator Pro!';
                document.getElementById('successMessage').style.display = 'block';
                return; // Allow access
            }
            
            // No valid access - show denied page
            console.log('No valid access - showing denied page');
            showAccessDenied();
        };
        
        function showAccessDenied() {
            document.body.innerHTML = `
                <div style="max-width: 600px; margin: 100px auto; padding: 40px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <h1 style="color: #e74c3c;">🔒 Pro Access Required</h1>
                    <p style="font-size: 1.2em; margin: 20px 0;">This is the Pro version of our solar calculator.</p>
                    <p>To access advanced features like postcode-specific data, battery analysis, and detailed reports, you need Pro access.</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Pro Calculator Includes:</h3>
                        <ul style="text-align: left; display: inline-block;">
                            <li>📍 Your exact postcode sunshine hours</li>
                            <li>🔋 Battery storage ROI analysis</li>
                            <li>💰 Export tariff comparison</li>
                            <li>📊 Month-by-month breakdown</li>
                            <li>🏠 System size comparison</li>
                            <li>📈 25-year financial projections</li>
                        </ul>
                    </div>
                    
                    <a href="https://buy.stripe.com/28E28r7U0eic7qk2Zge3e00" style="background: #f57c00; color: white; padding: 15px 30px; text-decoration: none; border-radius: 50px; font-size: 1.2em; font-weight: bold; display: inline-block; margin: 20px;">
                        Get Pro Access - £4.99 →
                    </a>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">💡 Already purchased Pro access?</h4>
                        <p style="margin: 0 0 15px 0; font-size: 0.9em;">If you've cleared your browser data or are using a different device, we'll restore your access within 24 hours.</p>
                        
                        <form action="https://formsubmit.co/r.jenkins0912@gmail.com" method="POST" style="text-align: left;">
                            <input type="hidden" name="_subject" value="Pro Access Restoration Request">
                            <input type="hidden" name="_captcha" value="false">
                            <input type="hidden" name="_template" value="table">
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Your Email*</label>
                                <input type="email" name="email" required style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px;">
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Stripe Transaction ID (if available)</label>
                                <input type="text" name="transaction_id" placeholder="e.g., pi_1234567890" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Issue Description</label>
                                <textarea name="issue" rows="3" placeholder="e.g., Cleared browser cache and can't access Pro calculator" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                            </div>
                            
                            <button type="submit" style="background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 25px; font-size: 0.9em; cursor: pointer; width: 100%;">
                                Request Access Restoration →
                            </button>
                        </form>
                        
                        <p style="margin: 15px 0 0 0; font-size: 0.8em; color: #666;">We typically respond within 24 hours</p>
                    </div>
                    
                    <p style="margin-top: 20px;">
                        <a href="/" style="color: #3498db;">← Back to Free Calculator</a>
                    </p>
                </div>
            `;
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function calculateProROI() {
            // Track calculation
            if (typeof trackProCalculation === 'function') {
                trackProCalculation();
            }
            
            const postcode = document.getElementById('postcode').value;
            const systemSize = parseFloat(document.getElementById('systemSizePro').value);
            const currentRate = parseFloat(document.getElementById('currentTariff').value) / 100;
            const exportTariff = parseFloat(document.getElementById('exportTariff').value) / 100;
            const usagePattern = document.getElementById('energyUsagePattern').value;
            
            // Get system cost based on size
            const systemCosts = {
                '3': 4500,
                '4': 5500,
                '6': 7500,
                '8': 10000,
                '10': 13000
            };
            const systemCost = systemCosts[systemSize];
            
            // Get accurate postcode-specific data
            const sunshineHours = getSunshineHours(postcode);
            const efficiency = sunshineHours / 850; // UK average is 850
            
            // Advanced calculations
            const annualGeneration = systemSize * sunshineHours;
            
            // Usage pattern affects self-consumption
            const selfConsumption = usagePattern === 'day' ? 0.45 : 
                                   usagePattern === 'evening' ? 0.25 : 0.35;
            
            const selfUseAmount = annualGeneration * selfConsumption;
            const exportAmount = annualGeneration * (1 - selfConsumption);
            
            // Financial calculations
            const selfUseSavings = selfUseAmount * currentRate;
            const exportIncome = exportAmount * exportTariff;
            const firstYearSavings = selfUseSavings + exportIncome;
            
            // Calculate 25-year projections with degradation, inflation, and inverter costs
            let totalSavings = 0;
            let cumulativeSavings = -systemCost;
            let paybackYear = 25;
            
            for (let year = 1; year <= 25; year++) {
                const degradationFactor = Math.pow(0.995, year - 1);
                const inflationFactor = Math.pow(1.035, year - 1);
                let yearSavings = firstYearSavings * degradationFactor * inflationFactor;
                
                // Inverter replacements
                if (year === 10 || year === 20) {
                    yearSavings -= 1500;
                }
                
                totalSavings += yearSavings;
                cumulativeSavings += yearSavings;
                
                if (cumulativeSavings >= 0 && paybackYear === 25) {
                    paybackYear = year;
                }
            }
            
            // Update results
            document.getElementById('locationEfficiency').innerHTML = `${(efficiency * 100).toFixed(0)}%<br><small>${sunshineHours} hrs/year</small>`;
            document.getElementById('annualGeneration').innerHTML = `${annualGeneration.toFixed(0)} kWh<br><small>Year 1</small>`;
            document.getElementById('exportIncome').innerHTML = `£${exportIncome.toFixed(0)}<br><small>+ £${selfUseSavings.toFixed(0)} self-use</small>`;
            document.getElementById('truePayback').innerHTML = `${paybackYear} years<br><small>Inc. all costs</small>`;
            
            document.getElementById('proResults').style.display = 'block';
            
            // Generate system comparison
            generateSystemComparison(postcode, currentRate, exportTariff);
            // Generate monthly breakdown
            generateMonthlyBreakdown(annualGeneration, selfConsumption, currentRate, exportTariff);
        }
        
        function getSunshineHours(postcode) {
            // Regional sunshine hours (more accurate than before)
            const regions = {
                'SW': 1100, 'SE': 1050, 'E': 1000, 'W': 950,
                'NW': 900, 'NE': 900, 'SC': 850, 'N': 850,
                'BT': 850, 'PO': 1050, 'SO': 1050, 'TR': 1100,
                'PL': 1050, 'EX': 1050, 'TQ': 1050, 'TA': 1000,
                'BS': 1000, 'BA': 1000, 'GL': 950, 'OX': 950,
                'RG': 950, 'SL': 950, 'HP': 950, 'MK': 950,
                'CV': 900, 'B': 900, 'WS': 900, 'WV': 900,
                'LE': 900, 'NG': 900, 'DE': 900, 'ST': 900,
                'M': 900, 'SK': 900, 'L': 900, 'WA': 900,
                'CH': 900, 'CW': 900, 'SY': 900, 'TF': 900,
                'LL': 900, 'LD': 900, 'CF': 950, 'NP': 950,
                'SA': 950, 'HR': 900, 'WR': 900, 'DY': 900,
                'HU': 900, 'YO': 900, 'LS': 900, 'HX': 900,
                'HD': 900, 'BD': 900, 'WF': 900, 'DN': 900,
                'S': 900, 'NE': 850, 'SR': 850, 'DH': 850,
                'DL': 850, 'TS': 850, 'CA': 850, 'LA': 850,
                'FY': 850, 'PR': 850, 'BB': 850, 'BL': 850,
                'EH': 850, 'G': 850, 'KY': 850, 'DD': 850,
                'AB': 850, 'IV': 800, 'PH': 800, 'PA': 850,
                'KA': 850, 'ML': 850, 'FK': 850, 'TD': 850
            };
            
            const prefix = postcode.substring(0, 2).toUpperCase();
            return regions[prefix] || 900;
        }
        
        function calculateBatteryROI() {
            const batterySize = parseFloat(document.getElementById('batterySize').value);
            const nightRate = parseFloat(document.getElementById('timeOfUseRate').value) / 100;
            const dayRate = parseFloat(document.getElementById('dayRate').value) / 100;
            
            if (batterySize === 0) {
                document.getElementById('dailySavings').textContent = '£0';
                document.getElementById('batterySavings').textContent = '£0';
                document.getElementById('batteryPayback').textContent = 'N/A';
                document.getElementById('batteryVerdict').textContent = 'N/A';
                document.getElementById('timeShiftBreakdown').style.display = 'none';
            } else {
                // Battery costs
                const batteryCosts = {
                    '5': 2500,
                    '10': 5000,
                    '13.5': 8000,
                    '15': 7500
                };
                const batteryCost = batteryCosts[batterySize];
                
                // Calculate time-shifting savings
                const usableCapacity = batterySize * 0.9; // 90% depth of discharge
                const roundTripEfficiency = 0.9; // 90% efficiency
                const effectiveCapacity = usableCapacity * roundTripEfficiency;
                
                const dailySavings = effectiveCapacity * (dayRate - nightRate);
                const annualSavings = dailySavings * 365;
                const paybackYears = batteryCost / annualSavings;
                
                // Update results
                document.getElementById('dailySavings').textContent = `£${dailySavings.toFixed(2)}`;
                document.getElementById('batterySavings').textContent = `£${annualSavings.toFixed(0)}`;
                document.getElementById('batteryPayback').textContent = `${paybackYears.toFixed(1)} years`;
                document.getElementById('batteryVerdict').textContent = paybackYears <= 10 ? 'YES! ✓' : paybackYears <= 15 ? 'Maybe' : 'No ✗';
                
                // Show time-shift breakdown
                document.getElementById('timeShiftBreakdown').style.display = 'block';
                document.getElementById('chargeRate').textContent = `${(nightRate * 100).toFixed(1)}p/kWh`;
                document.getElementById('chargeCost').textContent = `-£${(usableCapacity * nightRate).toFixed(2)}`;
                document.getElementById('peakRate').textContent = `${(dayRate * 100).toFixed(2)}p/kWh`;
                document.getElementById('peakSaving').textContent = `+£${(effectiveCapacity * dayRate).toFixed(2)}`;
                document.getElementById('totalDailySaving').textContent = `£${dailySavings.toFixed(2)}`;
            }
            
            document.getElementById('batteryResults').style.display = 'block';
        }
        
        function generateSystemComparison(postcode, currentRate, exportRate) {
            const sizes = [3, 4, 6, 8];
            const sunshineHours = getSunshineHours(postcode);
            const container = document.getElementById('comparisonResults');
            container.innerHTML = '';
            
            sizes.forEach(size => {
                const div = document.createElement('div');
                div.className = 'system-comparison';
                
                const systemCosts = {
                    '3': 4500,
                    '4': 5500,
                    '6': 7500,
                    '8': 10000
                };
                const systemCost = systemCosts[size];
                
                if (size === 4 || size === 6) {
                    div.innerHTML = '<div class="best-choice">RECOMMENDED</div>';
                }
                
                const annualGeneration = size * sunshineHours;
                const annualSavings = annualGeneration * 0.35 * currentRate + annualGeneration * 0.65 * exportRate;
                const payback = systemCost / annualSavings;
                
                div.innerHTML += `
                    <h3>${size} kW System</h3>
                    <p style="color: #666;">Cost: £${systemCost.toLocaleString()}</p>
                    <div class="result-value">£${annualSavings.toFixed(0)}</div>
                    <p>Annual Savings</p>
                    <p style="margin-top: 10px;">Payback: ${payback.toFixed(1)} years</p>
                    <p style="font-size: 0.9em; color: #666;">ROI: ${((annualSavings * 25 - systemCost) / systemCost * 100).toFixed(0)}%</p>
                `;
                
                container.appendChild(div);
            });
        }
        
        function generateMonthlyBreakdown(annualGeneration, selfConsumption, currentRate, exportRate) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const distribution = [0.04, 0.05, 0.08, 0.10, 0.12, 0.13, 0.13, 0.12, 0.10, 0.07, 0.04, 0.02];
            
            const tbody = document.getElementById('monthlyData');
            tbody.innerHTML = '';
            
            months.forEach((month, i) => {
                const generation = annualGeneration * distribution[i];
                const selfUse = generation * selfConsumption;
                const exportGen = generation * (1 - selfConsumption);
                const savings = (selfUse * currentRate) + (exportGen * exportRate);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${month}</td>
                        <td>${generation.toFixed(0)}</td>
                        <td>${selfUse.toFixed(0)}</td>
                        <td>${exportGen.toFixed(0)}</td>
                        <td>£${savings.toFixed(0)}</td>
                    </tr>
                `;
            });
        }
        
        function generateReport() {
            // Track report download
            if (typeof trackReportDownload === 'function') {
                trackReportDownload();
            }
            
            const systemSize = document.getElementById('systemSizePro').value || '6';
            const postcode = document.getElementById('postcode').value || 'Your Location';
            const exportTariff = document.getElementById('exportTariff').value || '7.5';
            const currentTariff = document.getElementById('currentTariff').value || '27.03';
            const batterySize = document.getElementById('batterySize').value || '0';
            const roofArea = document.getElementById('roofArea').value || '40';
            const date = new Date().toLocaleDateString('en-GB');
            const reportId = 'SRC-' + Date.now();
            
            // Get system cost
            const systemCosts = {
                '3': 4500,
                '4': 5500,
                '6': 7500,
                '8': 10000,
                '10': 13000
            };
            const systemCost = systemCosts[systemSize];
            
            // Get actual calculated values
            const sunshineHours = getSunshineHours(postcode);
            const annualGeneration = systemSize * sunshineHours;
            const selfConsumption = 0.35;
            const annualSelfUse = annualGeneration * selfConsumption;
            const annualExport = annualGeneration * (1 - selfConsumption);
            const annualSelfUseSavings = annualSelfUse * (parseFloat(currentTariff) / 100);
            const annualExportIncome = annualExport * (parseFloat(exportTariff) / 100);
            const totalAnnualSavings = annualSelfUseSavings + annualExportIncome;
            const paybackYears = systemCost / totalAnnualSavings;
            
            const reportContent = `================================================================================
                      SOLAR INVESTMENT ANALYSIS
================================================================================

Generated: ${date}
Report Reference: ${reportId}
Prepared for: ${postcode}

================================================================================
                            EXECUTIVE SUMMARY
================================================================================

INVESTMENT OVERVIEW
-------------------
System Size:                ${systemSize} kW
Total Investment:           £${systemCost.toLocaleString()}
Payback Period:             ${paybackYears.toFixed(1)} years
25-Year Net Profit:         £${((totalAnnualSavings * 25 * 1.5) - systemCost).toFixed(0)}
Return on Investment:       ${(((totalAnnualSavings * 25 * 1.5) - systemCost) / systemCost * 100).toFixed(0)}%

KEY FINDINGS
------------
✓ Your solar investment will pay for itself in ${Math.ceil(paybackYears)} years
✓ You'll save £${totalAnnualSavings.toFixed(0)} in the first year alone
✓ Over 25 years, you'll make £${((totalAnnualSavings * 25 * 1.5) - systemCost).toFixed(0)} profit
✓ Your home will generate ${annualGeneration.toFixed(0)} kWh annually

RECOMMENDATION: ${paybackYears <= 8 ? 'EXCELLENT INVESTMENT - PROCEED' : paybackYears <= 10 ? 'GOOD INVESTMENT - RECOMMENDED' : 'MODERATE INVESTMENT - CONSIDER CAREFULLY'}

================================================================================
                        DETAILED SYSTEM ANALYSIS
================================================================================

LOCATION ANALYSIS
-----------------
Postcode:                   ${postcode}
Sunshine Hours:             ${sunshineHours} hours/year
Location Efficiency:        ${((sunshineHours / 850) * 100).toFixed(0)}% vs UK average
Available Roof Area:        ${roofArea} m²
Current Electricity Rate:   ${currentTariff}p/kWh (Ofgem cap - drops to 25.73p July 2025)

SYSTEM SPECIFICATIONS
--------------------
Recommended Size:           ${systemSize} kW
Number of Panels:           ${Math.round(systemSize * 4)} × 250W panels
Roof Area Required:         ${Math.round(systemSize * 8)} m²
Annual Generation:          ${annualGeneration.toFixed(0)} kWh
System Efficiency:          ${(selfConsumption * 100).toFixed(0)}% self-consumption

[Full report continues with monthly breakdown, financial projections, etc...]

================================================================================
                    END OF ANALYSIS
                    
Report generated by: Solar ROI Calculator Pro
Website: https://solarroicalculator.co.uk
Report ID: ${reportId}
Date: ${date}
================================================================================`;
            
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Solar_Investment_Analysis_${postcode.replace(/\s+/g, '_')}_${date.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>