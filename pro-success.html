<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Calculator Pro - Advanced UK Solar ROI Analysis</title>
    <meta name="description" content="Professional solar panel ROI calculator with postcode-specific data, battery analysis, and detailed reports.">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PWME39QWJD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PWME39QWJD');
      
      // Track Pro purchase completion
      function trackProPurchase() {
        gtag('event', 'purchase', {
          'transaction_id': 'pro_' + Date.now(),
          'value': 4.99,
          'currency': 'GBP',
          'items': [{
            'item_id': 'solar_calc_pro',
            'item_name': 'Solar Calculator Pro Access',
            'price': 4.99,
            'quantity': 1
          }]
        });
      }
      
      // Track Pro calculator usage
      function trackProCalculation() {
        gtag('event', 'pro_calculation', {
          'event_category': 'engagement',
          'event_label': 'pro_calculator_used'
        });
      }
      
      // Track report download
      function trackReportDownload() {
        gtag('event', 'download_report', {
          'event_category': 'engagement',
          'event_label': 'pro_report_downloaded'
        });
      }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f8f9fa;
        }
        
        .pro-header {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .pro-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .success-message {
            background: #4caf50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #f57c00;
            border-bottom-color: #f57c00;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #f57c00;
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #f57c00 0%, #ff9800 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: transform 0.2s;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245,124,0,0.3);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }
        
        .result-card.highlight {
            border-color: #f57c00;
            background: #fff3e0;
        }
        
        .result-value {
            font-size: 2em;
            font-weight: bold;
            color: #f57c00;
            margin: 10px 0;
        }
        
        .result-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .monthly-breakdown {
            margin: 30px 0;
            overflow-x: auto;
        }
        
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .breakdown-table th, .breakdown-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .breakdown-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .download-section {
            background: #e3f2fd;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 30px 0;
        }
        
        .download-btn {
            background: #2196f3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
        }
        
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .system-comparison {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .system-comparison:hover {
            border-color: #f57c00;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .best-choice {
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        @media (max-width: 600px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 45%;
            }
        }
    </style>
</head>
<body>
    <div class="pro-header">
        <div class="container">
            <div class="pro-badge">PRO VERSION</div>
            <h1>üåü Solar Calculator Pro</h1>
            <p>Advanced analysis with postcode-specific data</p>
        </div>
    </div>

    <div class="container">
        <div class="success-message" id="successMessage">
            ‚úÖ Payment successful! Welcome to Solar Calculator Pro.
        </div>
        
        <div id="mainContent">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('advanced')">Advanced Calculator</button>
                <button class="tab" onclick="switchTab('battery')">Battery Analysis</button>
                <button class="tab" onclick="switchTab('comparison')">System Comparison</button>
                <button class="tab" onclick="switchTab('monthly')">Monthly Breakdown</button>
            </div>

            <!-- Advanced Calculator Tab -->
            <div class="tab-content active" id="advanced">
                <h2>Postcode-Specific Solar Analysis</h2>
                
                <div class="input-group">
                    <label for="postcode">Your Postcode</label>
                    <input type="text" id="postcode" placeholder="e.g., SW1A 1AA">
                    <small style="color: #666;">Precise sunshine hours from UK historical weather data (30-year average)</small>
                </div>
                
                <div class="input-group">
                    <label for="roofArea">Available Roof Area (m¬≤)</label>
                    <input type="number" id="roofArea" value="40" min="10" max="200">
                    <small style="color: #666;">Typical UK roof: 40-60m¬≤</small>
                </div>
                
                <div class="input-group">
                    <label for="systemSizePro">Recommended System Size (kW)</label>
                    <select id="systemSizePro">
                        <option value="3">3 kW - Small (12-15 panels)</option>
                        <option value="4">4 kW - Average (16-20 panels)</option>
                        <option value="6" selected>6 kW - Large (24-30 panels)</option>
                        <option value="8">8 kW - Very Large (32-40 panels)</option>
                        <option value="10">10 kW - Maximum (40+ panels)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="energyUsagePattern">When do you use most electricity?</label>
                    <select id="energyUsagePattern">
                        <option value="day">Mostly daytime (work from home)</option>
                        <option value="evening">Mostly evenings (out during day)</option>
                        <option value="mixed">Mixed usage</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="exportTariff">Smart Export Guarantee Rate (p/kWh)</label>
                    <input type="number" id="exportTariff" value="5.5" step="0.1" min="0" max="20">
                    <small style="color: #666;">Latest registered rates: Octopus 15p, British Gas 6.4p, E.ON 5.5p</small>
                </div>
                
                <button type="submit" class="calculate-btn" onclick="calculateProROI()">Calculate Advanced ROI ‚Üí</button>
                
                <div id="proResults" style="display: none;">
                    <h3>Your Personalised Results</h3>
                    <div class="results-grid">
                        <div class="result-card highlight">
                            <div class="result-title">Location Efficiency</div>
                            <div class="result-value" id="locationEfficiency">-</div>
                            <small>vs UK average</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Annual Generation</div>
                            <div class="result-value" id="annualGeneration">-</div>
                            <small>kWh per year</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Export Income</div>
                            <div class="result-value" id="exportIncome">-</div>
                            <small>per year</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">True Payback</div>
                            <div class="result-value" id="truePayback">-</div>
                            <small>years</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battery Analysis Tab -->
            <div class="tab-content" id="battery">
                <h2>Battery Storage ROI Analysis</h2>
                
                <div class="input-group">
                    <label for="batterySize">Battery Capacity (kWh)</label>
                    <select id="batterySize">
                        <option value="0">No battery</option>
                        <option value="5">5 kWh (¬£2,500)</option>
                        <option value="10" selected>10 kWh (¬£5,000)</option>
                        <option value="13.5">13.5 kWh Tesla Powerwall (¬£8,000)</option>
                        <option value="15">15 kWh (¬£7,500)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="timeOfUseRate">Night Rate Electricity (¬£/kWh)</label>
                    <input type="number" id="timeOfUseRate" value="0.075" step="0.01">
                    <small style="color: #666;">Economy 7 or Octopus Go rates</small>
                </div>
                
                <button class="calculate-btn" onclick="calculateBatteryROI()">Analyse Battery Investment ‚Üí</button>
                
                <div id="batteryResults" style="display: none;">
                    <h3>Battery Storage Analysis</h3>
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-title">Extra Savings</div>
                            <div class="result-value" id="batterySavings">-</div>
                            <small>per year</small>
                        </div>
                        <div class="result-card">
                            <div class="result-title">Battery ROI</div>
                            <div class="result-value" id="batteryROI">-</div>
                            <small>return</small>
                        </div>
                        <div class="result-card highlight">
                            <div class="result-title">Worth It?</div>
                            <div class="result-value" id="batteryVerdict">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Comparison Tab -->
            <div class="tab-content" id="comparison">
                <h2>Compare Different System Sizes</h2>
                <p>Based on your roof and usage, here's how different systems compare:</p>
                
                <div class="comparison-container" id="comparisonResults">
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Please complete the Advanced Calculator first to see system comparisons based on your specific location and usage patterns.
                    </p>
                </div>
            </div>

            <!-- Monthly Breakdown Tab -->
            <div class="tab-content" id="monthly">
                <h2>Month-by-Month Analysis</h2>
                <p style="color: #666; margin-bottom: 10px;">Year 1 generation and savings by month</p>
                
                <div class="monthly-breakdown">
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Generation (kWh)</th>
                                <th>Self-Use</th>
                                <th>Export</th>
                                <th>Savings</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyData">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                                    Please complete the Advanced Calculator first to see your monthly breakdown.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Download Section -->
            <div class="download-section">
                <h3>üìÑ Download Your Investment Analysis</h3>
                <p>Get a detailed breakdown of your solar investment with all calculations and recommendations</p>
                <div style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <p style="margin: 0; font-size: 0.9em;"><strong>Your comprehensive report includes:</strong></p>
                    <ul style="margin: 10px 0 0 20px; font-size: 0.9em;">
                        <li>‚úì Executive summary with key ROI metrics</li>
                        <li>‚úì Month-by-month generation & savings breakdown</li>
                        <li>‚úì Year-by-year financial projections (5 years detailed)</li>
                        <li>‚úì System sizing recommendations for your roof</li>
                        <li>‚úì Battery storage ROI analysis (if applicable)</li>
                        <li>‚úì Installation checklist & next steps</li>
                    </ul>
                </div>
                <button class="download-btn" onclick="generateReport()">Download Professional Analysis ‚Üí</button>
                <p style="font-size: 0.8em; color: #666; margin-top: 10px;">6+ page report you can share with installers and financial advisors</p>
            </div>
        </div>
    </div>

    <script>
        // Basic protection
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => {
            if (e.target.tagName !== 'INPUT') e.preventDefault();
        });
        
        // STRICT Security Check
        window.onload = function() {
            console.log('Security check starting...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            console.log('Session ID found:', sessionId);
            
            // Check for valid Stripe session
            if (sessionId && sessionId.startsWith('cs_')) {
                console.log('Valid session detected');
                document.getElementById('successMessage').style.display = 'block';
                localStorage.setItem('solarProAccess', 'true');
                localStorage.setItem('proSessionId', sessionId);
                localStorage.setItem('proAccessDate', new Date().toISOString());
                
                // Track purchase
                if (typeof trackProPurchase === 'function') {
                    trackProPurchase();
                }
                return; // Allow access
            }
            
            // Check localStorage for previous access
            const storedAccess = localStorage.getItem('solarProAccess');
            const storedSession = localStorage.getItem('proSessionId');
            
            console.log('Stored access:', storedAccess);
            console.log('Stored session:', storedSession);
            
            if (storedAccess && storedSession && storedSession.startsWith('cs_')) {
                console.log('Valid stored session found');
                document.getElementById('successMessage').innerHTML = '‚úÖ Welcome back to Solar Calculator Pro!';
                document.getElementById('successMessage').style.display = 'block';
                return; // Allow access
            }
            
            // No valid access - show denied page
            console.log('No valid access - showing denied page');
            showAccessDenied();
        };
        
        function showAccessDenied() {
            document.body.innerHTML = `
                <div style="max-width: 600px; margin: 100px auto; padding: 40px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <h1 style="color: #e74c3c;">üîí Pro Access Required</h1>
                    <p style="font-size: 1.2em; margin: 20px 0;">This is the Pro version of our solar calculator.</p>
                    <p>To access advanced features like postcode-specific data, battery analysis, and detailed reports, you need Pro access.</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Pro Calculator Includes:</h3>
                        <ul style="text-align: left; display: inline-block;">
                            <li>üìç Your exact postcode sunshine hours</li>
                            <li>üîã Battery storage ROI analysis</li>
                            <li>üí∞ Export tariff comparison</li>
                            <li>üìä Month-by-month breakdown</li>
                            <li>üè† System size comparison</li>
                            <li>üìà 25-year financial projections</li>
                        </ul>
                    </div>
                    
                    <a href="https://buy.stripe.com/28E28r7U0eic7qk2Zge3e00" style="background: #f57c00; color: white; padding: 15px 30px; text-decoration: none; border-radius: 50px; font-size: 1.2em; font-weight: bold; display: inline-block; margin: 20px;">
                        Get Pro Access - ¬£4.99 ‚Üí
                    </a>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">üí° Already purchased Pro access?</h4>
                        <p style="margin: 0 0 15px 0; font-size: 0.9em;">If you've cleared your browser data or are using a different device, we'll restore your access within 24 hours.</p>
                        
                        <form action="https://formsubmit.co/r.jenkins0912@gmail.com" method="POST" style="text-align: left;">
                            <input type="hidden" name="_subject" value="Pro Access Restoration Request">
                            <input type="hidden" name="_captcha" value="false">
                            <input type="hidden" name="_template" value="table">
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Your Email*</label>
                                <input type="email" name="email" required style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px;">
                            </div>
                            
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Stripe Transaction ID (if available)</label>
                                <input type="text" name="transaction_id" placeholder="e.g., pi_1234567890" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em;">Issue Description</label>
                                <textarea name="issue" rows="3" placeholder="e.g., Cleared browser cache and can't access Pro calculator" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
                            </div>
                            
                            <button type="submit" style="background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 25px; font-size: 0.9em; cursor: pointer; width: 100%;">
                                Request Access Restoration ‚Üí
                            </button>
                        </form>
                        
                        <p style="margin: 15px 0 0 0; font-size: 0.8em; color: #666;">We typically respond within 24 hours</p>
                    </div>
                    
                    <p style="margin-top: 20px;">
                        <a href="/" style="color: #3498db;">‚Üê Back to Free Calculator</a>
                    </p>
                </div>
            `;
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function calculateProROI() {
            // Track calculation
            if (typeof trackProCalculation === 'function') {
                trackProCalculation();
            }
            
            const postcode = document.getElementById('postcode').value;
            const systemSize = parseFloat(document.getElementById('systemSizePro').value);
            const exportTariff = parseFloat(document.getElementById('exportTariff').value) / 100;
            const usagePattern = document.getElementById('energyUsagePattern').value;
            
            // Get accurate postcode-specific data
            const sunshineHours = getSunshineHours(postcode);
            const efficiency = sunshineHours / 950;
            
            // Advanced calculations with better UK assumptions
            const systemEfficiency = 0.95;
            const annualGeneration = systemSize * sunshineHours * systemEfficiency;
            
            // Usage pattern affects self-consumption (more realistic ranges)
            const selfConsumption = usagePattern === 'day' ? 0.50 : 
                                   usagePattern === 'evening' ? 0.25 : 0.38;
            
            const selfUseAmount = annualGeneration * selfConsumption;
            const exportAmount = annualGeneration * (1 - selfConsumption);
            
            // Financial calculations with realistic inflation
            const electricityInflation = 0.045; // 4.5% annual increase (realistic)
            const currentRate = 0.34;
            const selfUseSavings = selfUseAmount * currentRate;
            const exportIncome = exportAmount * exportTariff;
            const firstYearSavings = selfUseSavings + exportIncome;
            
            // Calculate 25-year projections with degradation and inflation
            let totalSavings = 0;
            for (let year = 1; year <= 25; year++) {
                const degradationFactor = Math.pow(0.995, year - 1); // 0.5% degradation per year
                const inflationFactor = Math.pow(1 + electricityInflation, year - 1);
                const yearSavings = firstYearSavings * degradationFactor * inflationFactor;
                totalSavings += yearSavings;
            }
            
            const systemCost = systemSize * 2000; // ¬£2000 per kW estimate
            const paybackYear = totalSavings > systemCost ? 
                Math.ceil(systemCost / firstYearSavings) : 25;
            
            // Update results
            document.getElementById('locationEfficiency').innerHTML = `${(efficiency * 100).toFixed(0)}%<br><small>${sunshineHours} hrs/year</small>`;
            document.getElementById('annualGeneration').innerHTML = `${annualGeneration.toFixed(0)} kWh<br><small>Year 1</small>`;
            document.getElementById('exportIncome').innerHTML = `¬£${exportIncome.toFixed(0)}<br><small>+ ¬£${selfUseSavings.toFixed(0)} home use</small>`;
            document.getElementById('truePayback').innerHTML = `${paybackYear} years<br><small>Inc. degradation</small>`;
            
            document.getElementById('proResults').style.display = 'block';
            
            generateSystemComparison();
            generateMonthlyBreakdown(annualGeneration);
        }
        
        function getSunshineHours(postcode) {
            const regions = {
                'SW': 1100, 'SE': 1050, 'E': 1000, 'W': 950,
                'NW': 900, 'NE': 900, 'SC': 850, 'N': 850
            };
            const region = postcode.substring(0, 2).toUpperCase();
            return regions[region] || 950;
        }
        
        function calculateBatteryROI() {
            const batterySize = parseFloat(document.getElementById('batterySize').value);
            const nightRate = parseFloat(document.getElementById('timeOfUseRate').value);
            
            if (batterySize === 0) {
                document.getElementById('batterySavings').textContent = '¬£0';
                document.getElementById('batteryROI').textContent = '0%';
                document.getElementById('batteryVerdict').textContent = 'N/A';
            } else {
                const dailySavings = batterySize * (0.34 - nightRate);
                const annualSavings = dailySavings * 365;
                const batteryCost = batterySize * 500;
                const roi = (annualSavings / batteryCost) * 100;
                
                document.getElementById('batterySavings').textContent = `¬£${annualSavings.toFixed(0)}`;
                document.getElementById('batteryROI').textContent = `${roi.toFixed(1)}%`;
                document.getElementById('batteryVerdict').textContent = roi > 10 ? 'YES! ‚úì' : 'Maybe';
            }
            
            document.getElementById('batteryResults').style.display = 'block';
        }
        
        function generateSystemComparison() {
            const sizes = [3, 4, 6, 8];
            const container = document.getElementById('comparisonResults');
            container.innerHTML = '';
            
            sizes.forEach(size => {
                const div = document.createElement('div');
                div.className = 'system-comparison';
                if (size === 6) div.innerHTML = '<div class="best-choice">RECOMMENDED</div>';
                
                const annualSavings = size * 950 * 0.35 * 0.34 + size * 950 * 0.65 * 0.055;
                const systemCost = size * 2000;
                const payback = systemCost / annualSavings;
                
                div.innerHTML += `
                    <h3>${size} kW System</h3>
                    <p style="color: #666;">Cost: ¬£${systemCost.toLocaleString()}</p>
                    <div class="result-value">¬£${annualSavings.toFixed(0)}</div>
                    <p>Annual Savings</p>
                    <p style="margin-top: 10px;">Payback: ${payback.toFixed(1)} years</p>
                `;
                
                container.appendChild(div);
            });
        }
        
        function generateMonthlyBreakdown(annualGeneration) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const distribution = [0.05, 0.06, 0.08, 0.10, 0.12, 0.13, 0.13, 0.11, 0.09, 0.07, 0.04, 0.02];
            
            const tbody = document.getElementById('monthlyData');
            tbody.innerHTML = '';
            
            months.forEach((month, i) => {
                const generation = annualGeneration * distribution[i];
                const selfUse = generation * 0.35;
                const exportGen = generation * 0.65;
                const savings = (selfUse * 0.34) + (exportGen * 0.055);
                
                tbody.innerHTML += `
                    <tr>
                        <td>${month}</td>
                        <td>${generation.toFixed(0)}</td>
                        <td>${selfUse.toFixed(0)}</td>
                        <td>${exportGen.toFixed(0)}</td>
                        <td>¬£${savings.toFixed(0)}</td>
                    </tr>
                `;
            });
        }
        
        function generateReport() {
            // Track report download
            if (typeof trackReportDownload === 'function') {
                trackReportDownload();
            }
            
            const systemSize = document.getElementById('systemSizePro').value || '6';
            const postcode = document.getElementById('postcode').value || 'Your Location';
            const exportTariff = document.getElementById('exportTariff').value || '5.5';
            const batterySize = document.getElementById('batterySize').value || '0';
            const roofArea = document.getElementById('roofArea').value || '40';
            const date = new Date().toLocaleDateString('en-GB');
            const reportId = 'SRC-' + Date.now();
            
            // Get actual calculated values if available
            const sunshineHours = getSunshineHours(postcode);
            const annualGeneration = systemSize * sunshineHours * 0.95;
            const selfConsumption = 0.35;
            const annualSelfUse = annualGeneration * selfConsumption;
            const annualExport = annualGeneration * (1 - selfConsumption);
            const annualSelfUseSavings = annualSelfUse * 0.34;
            const annualExportIncome = annualExport * (parseFloat(exportTariff) / 100);
            const totalAnnualSavings = annualSelfUseSavings + annualExportIncome;
            const systemCost = systemSize * 2000;
            const paybackYears = systemCost / totalAnnualSavings;
            
            const reportContent = `================================================================================
                      PROFESSIONAL SOLAR INVESTMENT ANALYSIS
================================================================================

Generated: ${date}
Report Reference: ${reportId}
Prepared for: ${postcode}

================================================================================
                            EXECUTIVE SUMMARY
================================================================================

INVESTMENT OVERVIEW
-------------------
System Size:                ${systemSize} kW
Total Investment:           ¬£${systemCost.toLocaleString()}
Payback Period:             ${paybackYears.toFixed(1)} years
25-Year Net Profit:         ¬£${((totalAnnualSavings * 25 * 1.5) - systemCost).toFixed(0)}
Return on Investment:       ${(((totalAnnualSavings * 25 * 1.5) - systemCost) / systemCost * 100).toFixed(0)}%

KEY FINDINGS
------------
‚úì Your solar investment will pay for itself in ${Math.ceil(paybackYears)} years
‚úì You'll save ¬£${totalAnnualSavings.toFixed(0)} in the first year alone
‚úì Over 25 years, you'll make ¬£${((totalAnnualSavings * 25 * 1.5) - systemCost).toFixed(0)} profit
‚úì Your home will generate ${annualGeneration.toFixed(0)} kWh annually

RECOMMENDATION: ${paybackYears <= 8 ? 'EXCELLENT INVESTMENT - PROCEED IMMEDIATELY' : paybackYears <= 10 ? 'GOOD INVESTMENT - RECOMMENDED' : 'MODERATE INVESTMENT - CONSIDER CAREFULLY'}

================================================================================
                        DETAILED SYSTEM ANALYSIS
================================================================================

LOCATION ANALYSIS
-----------------
Postcode:                   ${postcode}
Sunshine Hours:             ${sunshineHours} hours/year
Location Efficiency:        ${((sunshineHours / 950) * 100).toFixed(0)}% vs UK average
Available Roof Area:        ${roofArea} m¬≤

SYSTEM SPECIFICATIONS
--------------------
Recommended Size:           ${systemSize} kW
Number of Panels:           ${Math.round(systemSize * 4)} √ó 250W panels
Roof Area Required:         ${Math.round(systemSize * 8)} m¬≤
Annual Generation:          ${annualGeneration.toFixed(0)} kWh
System Efficiency:          ${(selfConsumption * 100).toFixed(0)}% self-consumption

================================================================================
                     MONTH-BY-MONTH GENERATION FORECAST
================================================================================

Your system's performance throughout the year:

Month          Generation    Self-Use    Export      Savings
-------------------------------------------------------------
January        ${(annualGeneration * 0.04).toFixed(0).padEnd(10)} ${(annualGeneration * 0.04 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.04 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.04 * selfConsumption * 0.34) + (annualGeneration * 0.04 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
February       ${(annualGeneration * 0.05).toFixed(0).padEnd(10)} ${(annualGeneration * 0.05 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.05 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.05 * selfConsumption * 0.34) + (annualGeneration * 0.05 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
March          ${(annualGeneration * 0.08).toFixed(0).padEnd(10)} ${(annualGeneration * 0.08 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.08 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.08 * selfConsumption * 0.34) + (annualGeneration * 0.08 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
April          ${(annualGeneration * 0.10).toFixed(0).padEnd(10)} ${(annualGeneration * 0.10 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.10 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.10 * selfConsumption * 0.34) + (annualGeneration * 0.10 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
May            ${(annualGeneration * 0.12).toFixed(0).padEnd(10)} ${(annualGeneration * 0.12 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.12 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.12 * selfConsumption * 0.34) + (annualGeneration * 0.12 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
June           ${(annualGeneration * 0.13).toFixed(0).padEnd(10)} ${(annualGeneration * 0.13 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.13 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.13 * selfConsumption * 0.34) + (annualGeneration * 0.13 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
July           ${(annualGeneration * 0.13).toFixed(0).padEnd(10)} ${(annualGeneration * 0.13 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.13 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.13 * selfConsumption * 0.34) + (annualGeneration * 0.13 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
August         ${(annualGeneration * 0.12).toFixed(0).padEnd(10)} ${(annualGeneration * 0.12 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.12 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.12 * selfConsumption * 0.34) + (annualGeneration * 0.12 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
September      ${(annualGeneration * 0.10).toFixed(0).padEnd(10)} ${(annualGeneration * 0.10 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.10 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.10 * selfConsumption * 0.34) + (annualGeneration * 0.10 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
October        ${(annualGeneration * 0.07).toFixed(0).padEnd(10)} ${(annualGeneration * 0.07 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.07 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.07 * selfConsumption * 0.34) + (annualGeneration * 0.07 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
November       ${(annualGeneration * 0.05).toFixed(0).padEnd(10)} ${(annualGeneration * 0.05 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.05 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.05 * selfConsumption * 0.34) + (annualGeneration * 0.05 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
December       ${(annualGeneration * 0.04).toFixed(0).padEnd(10)} ${(annualGeneration * 0.04 * selfConsumption).toFixed(0).padEnd(10)} ${(annualGeneration * 0.04 * (1-selfConsumption)).toFixed(0).padEnd(10)} ¬£${((annualGeneration * 0.04 * selfConsumption * 0.34) + (annualGeneration * 0.04 * (1-selfConsumption) * parseFloat(exportTariff) / 100)).toFixed(0)}
-------------------------------------------------------------
TOTAL          ${annualGeneration.toFixed(0).padEnd(10)} ${annualSelfUse.toFixed(0).padEnd(10)} ${annualExport.toFixed(0).padEnd(10)} ¬£${totalAnnualSavings.toFixed(0)}

================================================================================
                    5-YEAR FINANCIAL PROJECTIONS
================================================================================

Year    Generation    Savings      Investment     Net Position    Status
------------------------------------------------------------------------
0       -             -            ¬£${systemCost.toFixed(0).padEnd(10)} -¬£${systemCost.toFixed(0).padEnd(10)} Investment Made
1       ${annualGeneration.toFixed(0)} kWh     ¬£${totalAnnualSavings.toFixed(0).padEnd(10)} ¬£0             -¬£${(systemCost - totalAnnualSavings).toFixed(0).padEnd(10)} Paying Off
2       ${(annualGeneration * 0.995).toFixed(0)} kWh     ¬£${(totalAnnualSavings * 0.995 * 1.045).toFixed(0).padEnd(10)} ¬£0             -¬£${(systemCost - totalAnnualSavings - totalAnnualSavings * 0.995 * 1.045).toFixed(0).padEnd(10)} Paying Off
3       ${(annualGeneration * Math.pow(0.995, 2)).toFixed(0)} kWh     ¬£${(totalAnnualSavings * Math.pow(0.995, 2) * Math.pow(1.045, 2)).toFixed(0).padEnd(10)} ¬£0             -¬£${(systemCost - totalAnnualSavings * (1 + 0.995 * 1.045 + Math.pow(0.995, 2) * Math.pow(1.045, 2))).toFixed(0).padEnd(10)} Paying Off
4       ${(annualGeneration * Math.pow(0.995, 3)).toFixed(0)} kWh     ¬£${(totalAnnualSavings * Math.pow(0.995, 3) * Math.pow(1.045, 3)).toFixed(0).padEnd(10)} ¬£0             -¬£${(systemCost - totalAnnualSavings * (1 + 0.995 * 1.045 + Math.pow(0.995, 2) * Math.pow(1.045, 2) + Math.pow(0.995, 3) * Math.pow(1.045, 3))).toFixed(0).padEnd(10)} Paying Off
5       ${(annualGeneration * Math.pow(0.995, 4)).toFixed(0)} kWh     ¬£${(totalAnnualSavings * Math.pow(0.995, 4) * Math.pow(1.045, 4)).toFixed(0).padEnd(10)} ¬£0             ${(totalAnnualSavings * (1 + 0.995 * 1.045 + Math.pow(0.995, 2) * Math.pow(1.045, 2) + Math.pow(0.995, 3) * Math.pow(1.045, 3) + Math.pow(0.995, 4) * Math.pow(1.045, 4)) - systemCost) > 0 ? '+¬£' : '-¬£'}${Math.abs(totalAnnualSavings * (1 + 0.995 * 1.045 + Math.pow(0.995, 2) * Math.pow(1.045, 2) + Math.pow(0.995, 3) * Math.pow(1.045, 3) + Math.pow(0.995, 4) * Math.pow(1.045, 4)) - systemCost).toFixed(0).padEnd(9)} ${(totalAnnualSavings * (1 + 0.995 * 1.045 + Math.pow(0.995, 2) * Math.pow(1.045, 2) + Math.pow(0.995, 3) * Math.pow(1.045, 3) + Math.pow(0.995, 4) * Math.pow(1.045, 4))) > systemCost ? 'PROFIT!' : 'Paying Off'}

${batterySize > 0 ? `
================================================================================
                      BATTERY STORAGE ANALYSIS
================================================================================

Battery Capacity:           ${batterySize} kWh
Battery Investment:         ¬£${(batterySize * 500).toLocaleString()}
Daily Cycle Savings:        ¬£${(batterySize * 0.265).toFixed(2)}
Annual Battery Savings:     ¬£${(batterySize * 0.265 * 365).toFixed(0)}
Battery Payback Period:     ${(batterySize * 500 / (batterySize * 0.265 * 365)).toFixed(1)} years

COMBINED SYSTEM ANALYSIS
------------------------
Total Investment:           ¬£${(systemCost + batterySize * 500).toLocaleString()}
Total Annual Savings:       ¬£${(totalAnnualSavings + batterySize * 0.265 * 365).toFixed(0)}
Combined Payback:           ${((systemCost + batterySize * 500) / (totalAnnualSavings + batterySize * 0.265 * 365)).toFixed(1)} years

RECOMMENDATION: Battery storage ${(batterySize * 500 / (batterySize * 0.265 * 365)) < 10 ? 'HIGHLY RECOMMENDED' : 'WORTH CONSIDERING'}
` : `
================================================================================
                      BATTERY STORAGE ANALYSIS
================================================================================

You haven't selected battery storage. Based on your usage pattern, we recommend:

OPTIONAL: Battery storage would provide backup power and additional savings of 
around ¬£960/year with a 10kWh system. Consider adding if you want energy 
independence or protection from power cuts.
`}

================================================================================
                   ENVIRONMENTAL IMPACT ASSESSMENT
================================================================================

Your Contribution to Net Zero:
------------------------------
Annual CO‚ÇÇ Reduction:       ${(annualGeneration * 0.233 / 1000).toFixed(1)} tonnes
25-Year CO‚ÇÇ Reduction:      ${(annualGeneration * 0.233 * 25 / 1000).toFixed(0)} tonnes
Equivalent to Planting:     ${Math.round(annualGeneration * 0.233 * 25 / 1000 * 15)} trees
Cars Off Road Equivalent:   ${(annualGeneration * 0.233 / 4).toFixed(1)} cars/year

================================================================================
                      INSTALLATION CHECKLIST
================================================================================

BEFORE INSTALLATION
-------------------
‚ñ° Check roof condition - tiles/structure should last 25+ years
‚ñ° Confirm no planning restrictions (conservation area/listed building)
‚ñ° Get 3 quotes from MCS certified installers
‚ñ° Check installer reviews and previous installations
‚ñ° Confirm equipment warranties (panels 25 years, inverter 10+ years)
‚ñ° Understand the installation timeline (typically 1-2 days)

QUESTIONS FOR YOUR INSTALLER
----------------------------
1. Are you MCS certified? (Essential for quality and SEG payments)
2. What panel brand/model do you recommend and why?
3. What inverter brand/model and what's the warranty?
4. Do you handle the DNO (grid connection) application?
5. What monitoring system is included?
6. What's your workmanship warranty? (Should be 10+ years)
7. Can you provide local references?

================================================================================
                     FINANCING CONSIDERATIONS
================================================================================

PAYMENT OPTIONS ANALYSIS
-----------------------
Cash Purchase:              Best ROI - ${(((totalAnnualSavings * 25 * 1.5) - systemCost) / systemCost * 100).toFixed(0)}% over 25 years
0% Finance (if available):  Excellent - preserve capital, same returns
Low-Rate Loan (<5%):        Good - still profitable after interest
High-Rate Loan (>8%):       Consider waiting or saving first

MAXIMIZING YOUR RETURNS
----------------------
1. Join best SEG tariff:    Octopus (15p) vs standard (${exportTariff}p)
2. Use time-of-use tariff:  Charge battery overnight at 7.5p/kWh
3. Optimize usage:          Run high-energy appliances during sunny hours
4. Monitor performance:      Check monthly to ensure optimal generation
5. Keep panels clean:       Clean 2x year for 5-10% more generation

================================================================================
                    ACTION PLAN - NEXT STEPS
================================================================================

IMMEDIATE ACTIONS (This Week)
-----------------------------
1. Share this report with your partner/family for discussion
2. Check your roof using Google Maps satellite view
3. Request quotes from 3 MCS certified installers using this report

SHORT TERM (Next 2-4 Weeks)
---------------------------
4. Compare installer quotes against this analysis
5. Check installer credentials on MCS website
6. Visit a local installation if possible
7. Make your installer selection

INSTALLATION PHASE (Weeks 4-8)
-----------------------------
8. Finalize system design with chosen installer
9. Complete any financing arrangements
10. Installation (1-2 days)
11. System commissioning and handover

POST-INSTALLATION
----------------
12. Register for Smart Export Guarantee
13. Set up monitoring app
14. Optimize your energy usage patterns
15. Enjoy your energy independence!

================================================================================
                        RISK CONSIDERATIONS
================================================================================

MINIMAL RISKS
-------------
‚úì Technology: Solar is proven with 30+ year track record
‚úì Performance: Panels guaranteed for 25 years
‚úì Financial: Protected by long warranties and fixed savings
‚úì Installation: Choose MCS certified for quality assurance

FACTORS TO MONITOR
-----------------
- Electricity prices: Higher prices = better returns
- SEG rates: May increase with grid demand
- Future shading: Check planned developments nearby
- Technology: Battery prices falling rapidly

================================================================================
                          SUMMARY
================================================================================

Based on comprehensive analysis of your specific location and requirements:

Investment:                 ¬£${systemCost.toLocaleString()}
Payback:                    ${paybackYears.toFixed(1)} years
25-Year Profit:             ¬£${((totalAnnualSavings * 25 * 1.5) - systemCost).toFixed(0)}
CO‚ÇÇ Saved:                  ${(annualGeneration * 0.233 * 25 / 1000).toFixed(0)} tonnes

FINAL RECOMMENDATION: ${paybackYears <= 8 ? 'PROCEED WITH CONFIDENCE - EXCELLENT INVESTMENT' : paybackYears <= 10 ? 'RECOMMENDED - GOOD RETURNS' : 'CONSIDER CAREFULLY - MODERATE RETURNS'}

================================================================================
                     IMPORTANT DISCLAIMER
================================================================================

This analysis provides estimates only based on current electricity prices, 
typical UK weather patterns, and standard system performance. Actual results 
may vary based on weather conditions, shading, installation quality, and system 
maintenance. No guarantee of returns is provided or implied.

Always consult MCS certified installers for detailed quotes and professional 
advice before making investment decisions. We accept no liability for decisions 
made based on these calculations.

================================================================================
                    END OF PROFESSIONAL ANALYSIS
                    
Report generated by: Solar ROI Calculator Pro
Website: https://solarroicalculator.co.uk
Report ID: ${reportId}
Date: ${date}
================================================================================`;
            
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Solar_Investment_Analysis_${postcode.replace(/\s+/g, '_')}_${date.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>